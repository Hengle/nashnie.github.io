---
layout: post
title:  "复杂地形的攀爬翻越系统"
date:   2019-6-23 21:20:00 +0800
categories: none
---
## 复杂地形的攀爬翻越系统

很多 FPS 游戏中比如和平精英，角色在运动中都可以攀爬或者翻越障碍物，这个系统很大程度上的丰富了玩家的操作趣味性以及竞技性。<br>

如何实现呢？<br>
我在实现这个系统的过程中受到了 UE CharacterMovement 的启发，<br>
首先前方检测障碍物，然后检测头顶障碍物，再然后检测窗户以及落脚点。基本上就这四部，具体实现步骤如下，<br>

### 检测前方和头顶的障碍物
1. 检测前方障碍物，前方距离可配置
2. 检测上方障碍物，高度分几个等级检测，不必和动画高度匹配，检测粒度可配置，比如每30cm
以上检测通过之后，Vault 和 Climb 分别执行后续检测

### 检测动作阶段
Vault，翻越<br>
1. 检测前方是否有障碍物窗户，检测距离可配置，检测前方距离等于可以翻越的障碍物厚度，比如90cm，capsule 的高度，可配置，比如44cm等，如果 Hit false，检测通过（因为如果hit true，那么没有必要执行第二步了，角色会卡住，掉不下去）
2. 检测下方是否有障碍物，检测一定的距离，比如>=50，（掉落阶段），如果 Hit false，检测通过
3. 成功翻越

Climb，攀爬<br>
1. 检测前方是否是否有障碍物，检测距离可配置，检测前方距离等于可以翻越的障碍物厚度，比如44cm（角色可以落脚的最小distance），capsule 的高度，可配置，比如>=88等，如果Hit false，检测通过
2. 检测下方是否有障碍物，检测一定的距离，比如<=50，（掉落阶段,也就是坡度）如果Hit true，检测通过
3. 成功攀爬

### 计算动画路径
Vault 和 climb 检测的过程中，记录几个坐标点，障碍物的第一个拐点、第二个拐点（如果是翻越的话）、落点<br>
检测成功以后，根据以上的几个点，提取 rootMotion 的路径数据，然后更新 NotifyEvt 对应的点即可（目前想到，调整对应的Z。是否需要调整xy方向的偏移，看效果而定）<br>
落点 Notify 开始，<br>

### 播放动画
播放动画<br>
Tick 更新提取的路径坐标，注意和动画每一帧都匹配<br>
同时在高帧数的情况下，插值帧数小数点<br>

### 性能优化
以上检测使用 ray 和 box 组合取代 capsule 来检测，用于提升性能。

感谢阅读。<br>


